# 架构更新说明

## 🎯 新架构：本地文件优先

### 核心理念
**所有操作优先写入本地文件系统，然后通过文件监听自动同步到网页端**

### 工作流程

```
用户操作（网页端）
    ↓
写入本地文件系统
    ↓
文件监听器检测到变化（Chokidar）
    ↓
同步到 projects.json
    ↓
WebSocket 广播更新
    ↓
网页端自动刷新显示
```

### 具体实现

#### 1. **上传图片**
- 网页端上传 → 保存到本地文件夹
- 如有 prompt → 保存为 `.txt` 文件
- 文件监听器检测到新文件
- 自动同步并通知前端

#### 2. **更新 Prompt**
- 网页端修改 → 直接写入 `.txt` 文件
- 文件监听器检测到文件变化
- 自动同步并通知前端

#### 3. **删除图片**
- 网页端删除 → 删除本地图片和 `.txt` 文件
- 文件监听器检测到文件删除
- 自动同步并通知前端

### 优势

✅ **避免重复**：所有操作只写一次文件，由文件监听统一同步
✅ **本地为主**：即使网页关闭，本地文件保持完整
✅ **双向同步**：外部修改文件也会自动同步到网页
✅ **更可靠**：文件系统是唯一的真实数据源

### 文件监听配置

```javascript
{
  awaitWriteFinish: {
    stabilityThreshold: 500,  // 文件写入完成后等待 500ms
    pollInterval: 100
  }
}
```

- 等待文件写入稳定后再同步
- 避免读取未完成的文件

### 调试信息

服务器控制台会显示：
- `✓ 文件添加: image.png`
- `✓ 文件删除: image.png`
- `✓ Prompt 更新: image.txt`
- `✓ 数据库已同步`

前端控制台会显示：
- `图片已保存到本地，等待自动同步...`
- `Prompt 已保存到本地，等待自动同步...`
- `图片已从本地删除，等待自动同步...`

### 解决的问题

1. ❌ **粘贴重复问题**：不再有双重触发，只写一次文件
2. ❌ **状态不一致**：文件系统是唯一数据源
3. ✅ **实时同步**：文件变化自动反映到网页

### 性能优化

- 文件变化延迟 200ms 后再同步，避免频繁触发
- 使用 `awaitWriteFinish` 确保文件完整写入
- WebSocket 只在数据真正变化时广播

---

现在的架构更加健壮，完全以本地文件系统为准！

## 🧩 马赛克编辑器工作流

1. 前端进入新的 `/projects/:projectId/mosaic/:imageId?` 路由，使用 `<canvas>` 渲染真实图片。
2. 用户在画布上拖拽时，只修改前端内存中的像素，不会立即写回文件，避免频繁 IO。
3. 点击 “保存马赛克” 后，通过 `PUT /api/images/:projectId/:imageId/mosaic` 上传合成后的 PNG。
4. 后端直接覆盖原始图片文件，并写入 `updatedAt` 时间戳，随后广播 `projects-updated`。
5. 文件监听器捕捉到变更会再次校准 `projects.json`，前端使用 `?v=updatedAt` cache busting 即刻看到最新图片。

> 还原按钮仅在前端执行，将 `canvas` 恢复为进入编辑器时的初始位图，不触发任何后端请求。
