# 测试指南

## 快速测试流程

### 1. 启动应用

```bash
npm start
```

应该看到：
```
✓ 数据目录初始化完成
✓ WebSocket 服务器初始化完成
✓ 文件监听器初始化完成
========================================
  Prompt 管理工具 - 后端服务
========================================
✓ HTTP 服务器: http://localhost:3001
✓ WebSocket 服务器: ws://localhost:3001
========================================
```

### 2. 测试基础功能

#### 2.1 打开文件夹

1. 访问 `http://localhost:5173`
2. 点击"打开文件夹"按钮
3. 选择一个包含图片的文件夹
4. 应该立即看到图片列表

**预期日志：**
```
✓ 扫描到 X 张图片
✓ 正在监听 1 个文件夹
```

#### 2.2 粘贴图片（乐观更新测试）

1. 复制一张图片到剪贴板
2. 在项目页面按 `Ctrl+V`
3. **关键**：图片应该**立即**显示（<10ms）
4. 图片应该有半透明效果和"⏳ 同步中..."徽章
5. 约 300-500ms 后，徽章消失，图片变为正常

**预期日志：**
```
✓ 图片已保存: [filename].png
✓ Prompt 已保存: [imageId].txt
✓ 同步新图片: [filename].png
✓ 数据库已同步
✓ WebSocket 广播: projects-updated
```

**成功标志：**
- ✅ 粘贴后立即看到图片（不等待）
- ✅ 图片有乐观状态视觉效果
- ✅ 效果自动消失
- ✅ 无重复图片

#### 2.3 编辑 Prompt（乐观更新测试）

1. 点击图片下方的 Prompt 输入框
2. 输入文本
3. **关键**：文本应该**立即**显示
4. 输入框应该有乐观状态（可选视觉效果）

**预期日志：**
```
✓ Prompt 已更新: [imageId].txt
✓ 数据库已同步
✓ WebSocket 广播: projects-updated
```

**成功标志：**
- ✅ 输入立即显示（无延迟）
- ✅ 控制台显示"✓ Prompt 已保存"

#### 2.4 删除图片（乐观更新测试）

1. 点击图片左上角的"⋯"菜单
2. 点击"🗑️ 删除图片"
3. 确认删除
4. **关键**：图片应该**立即**消失

**预期日志：**
```
✓ 图片已删除: [filename].png
✓ 文件删除: [filename].png
✓ 移除已删除的图片: 1 个
✓ 数据库已同步
```

**成功标志：**
- ✅ 删除后立即消失（不等待）
- ✅ 文件系统确实删除了文件

### 3. 测试文件监听

#### 3.1 外部添加图片

1. 用文件管理器打开项目文件夹
2. 复制一张图片到文件夹
3. Web 界面应该在 100-500ms 内自动显示新图片

**预期日志：**
```
✓ 文件添加: [filename].png
✓ 同步新图片: [filename].png
✓ 数据库已同步
✓ WebSocket 广播: projects-updated
```

#### 3.2 外部删除图片

1. 用文件管理器删除项目文件夹中的图片
2. Web 界面应该自动移除该图片

**预期日志：**
```
✓ 文件删除: [filename].png
✓ 移除已删除的图片: 1 个
✓ 数据库已同步
```

#### 3.3 外部编辑 Prompt

1. 用记事本编辑 .txt 文件
2. 保存后，Web 界面应该自动更新 prompt

**预期日志：**
```
✓ Prompt 更新: [imageId].txt
✓ 数据库已同步
```

### 4. 测试错误处理

#### 4.1 网络断开（模拟）

**前端修改测试：**

临时修改 `src/api/client.js`：

```javascript
async addImageToProject(projectId, file, prompt = '') {
  throw new Error('模拟网络错误') // 添加这行
  // ... 原代码
}
```

**测试步骤：**

1. 粘贴图片
2. 图片应该立即显示
3. 约 1 秒后，图片应该消失（回滚）
4. 控制台应该显示错误

**恢复：** 删除添加的 throw 语句

#### 4.2 服务器错误

1. 停止后端服务器（Ctrl+C）
2. 在前端粘贴图片
3. 图片立即显示，但会在超时后消失
4. 重启服务器，WebSocket 应该自动重连

**预期日志：**
```
⚠️ WebSocket 断开
🔄 1 秒后尝试重连... (第 1 次)
✅ WebSocket 已连接
```

### 5. 测试并发操作

#### 5.1 快速连续粘贴

1. 复制多张图片（Windows：选中多张后 Ctrl+C）
2. 快速连续按 Ctrl+V 多次
3. 所有图片应该立即显示
4. 不应该有重复

#### 5.2 粘贴同时编辑

1. 粘贴一张新图片
2. 立即编辑另一张图片的 prompt
3. 两个操作都应该正常完成
4. 无相互干扰

### 6. 性能检查

#### 6.1 响应时间测量

打开浏览器开发者工具 → Performance

1. 开始录制
2. 粘贴图片
3. 停止录制
4. 查看"从 paste 事件到 UI 更新"的时间

**目标：** < 10ms

#### 6.2 内存使用

打开 Performance Monitor：

1. 观察粘贴前的内存
2. 连续粘贴 10 张图片
3. 等待所有同步完成
4. 检查内存是否稳定（无泄漏）

### 7. WebSocket 测试

#### 7.1 多客户端同步

1. 打开两个浏览器标签页
2. 在标签页 A 粘贴图片
3. 标签页 B 应该自动显示新图片

#### 7.2 断线重连

1. 打开 DevTools → Network
2. 找到 WebSocket 连接
3. 右键 → Close connection
4. 观察控制台，应该自动重连

**预期日志：**
```
⚠️ WebSocket 断开
🔄 1 秒后尝试重连... (第 1 次)
✅ WebSocket 已连接
```

## 常见问题排查

### 问题：粘贴后没有立即显示

**检查：**
1. 浏览器控制台是否有错误
2. `ProjectContext.jsx` 是否正确更新
3. `addImageToProject` 是否正确调用乐观更新

**解决：**
- 确保 `isOptimistic: true` 被设置
- 确保 `setProjects` 在 `try` 块外执行

### 问题：图片显示后立即消失

**可能原因：**
1. 后端返回错误
2. 文件写入失败
3. 权限问题

**检查：**
- 后端日志是否有错误
- 文件夹是否有写权限
- 磁盘空间是否充足

### 问题：文件监听不工作

**检查：**
1. 后端日志是否显示"正在监听 X 个文件夹"
2. 文件夹路径是否正确
3. Chokidar 配置是否正确

**解决：**
- 重启服务器
- 检查 `fileWatcher.js` 配置
- 确保 `usePolling: true`

### 问题：WebSocket 断线不重连

**检查：**
1. `apiClient.reconnectAttempts` 是否超过最大值
2. 重连逻辑是否正确

**解决：**
- 刷新页面重置重连计数
- 检查 `client.js` 中的重连逻辑

## 性能基准

### 响应时间目标

| 操作 | 目标延迟 | 可接受延迟 |
|------|---------|----------|
| 粘贴显示 | <10ms | <50ms |
| 编辑显示 | <10ms | <30ms |
| 删除显示 | <10ms | <30ms |
| 文件同步 | 100-300ms | <500ms |
| WebSocket 推送 | 10-50ms | <100ms |

### 资源使用目标

| 指标 | 目标 | 限制 |
|------|------|------|
| 内存增长 | <10MB/100 图片 | <50MB |
| CPU 使用 | <5% 空闲 | <30% |
| 网络带宽 | 按需 | - |

## 测试报告模板

```markdown
## 测试日期：2024-XX-XX

### 测试环境
- OS: Windows 11
- Node.js: v18.x
- 浏览器: Chrome 120

### 功能测试
- [ ] 打开文件夹
- [ ] 粘贴图片（乐观更新）
- [ ] 编辑 Prompt（乐观更新）
- [ ] 删除图片（乐观更新）
- [ ] 文件监听同步
- [ ] WebSocket 实时更新
- [ ] 错误处理和回滚

### 性能测试
- 粘贴响应时间: ___ms
- 编辑响应时间: ___ms
- 删除响应时间: ___ms
- 文件同步延迟: ___ms

### 发现的问题
1. 
2. 

### 备注
```

## 自动化测试（计划）

未来添加：

```javascript
// 示例测试用例
describe('乐观更新', () => {
  it('粘贴图片应立即显示', async () => {
    const start = performance.now()
    await pasteImage()
    const end = performance.now()
    expect(end - start).toBeLessThan(10)
  })
})
```
